name: Auto Sync MongoDB to Firebase

on:
  schedule:
    # Chạy mỗi 30 phút
    - cron: '*/30 * * * *'
  
  # Cho phép chạy thủ công
  workflow_dispatch:
  
  # Chạy khi có push vào main (optional)
  push:
    branches: [ main ]
    paths:
      - 'sync-users.js'
      - '.github/workflows/sync-users.yml'

jobs:
  sync-users:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install firebase-admin mongodb dotenv --legacy-peer-deps
      
      - name: Create Firebase Admin Key
        run: |
          echo '${{ secrets.FIREBASE_ADMIN_KEY }}' > firebase-admin-key.json
      
      - name: Create .env file
        run: |
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" > .env
          echo "DB_NAME=aeckdb" >> .env
      
      - name: Sync new users to Firebase
        run: |
          node sync-users.js new
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          DB_NAME: aeckdb
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f firebase-admin-key.json
          rm -f .env
